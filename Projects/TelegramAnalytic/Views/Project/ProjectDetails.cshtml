@using Microsoft.AspNetCore.Mvc.TagHelpers
@model Telegram_Analytic.Models.ProjectModels.ProjectViewModel
@{
    ViewData["Title"] = Model.Name;
    Layout = "_Layout";
    var maxLinks = ViewBag.MaxLinksPerProject as int? ?? 20;
    var currentLinksCount = ViewBag.CurrentLinksCount as int? ?? 0;
    var linksLeft = maxLinks - currentLinksCount;
    var isBotAdmin = ViewBag.IsBotAdmin as bool? ?? false;
    var telegramChanelUrl = ViewBag.TelegramChanelUrl as string;
}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="container-fluid">
    @if (!string.IsNullOrEmpty(telegramChanelUrl) && !isBotAdmin)
    {
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-warning d-flex align-items-center" role="alert">
                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">Бот не является администратором группы</h5>
                    <p class="mb-0">
                        Для корректной работы системы необходимо добавить бота в канал
                        <strong>@telegramChanelUrl</strong> и предоставить ему права администратора.
                        Без этого отслеживание кликов будет недоступно.
                    </p>
                </div>
            </div>
        </div>
    </div>
    }
    <div class="row mb-4">
        <div class="col">
            <h1>@Model.Name</h1>
            <div class="text-muted">
                <small>Создан: @Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                @if (Model.UpdatedAt.HasValue)
                {
                    <small> | Обновлен: @Model.UpdatedAt.Value.ToString("dd.MM.yyyy HH:mm")</small>
                }
                @if (!string.IsNullOrEmpty(Model.TelegramChanelUrl))
                {
                    <small> | Telegram ID: @Model.TelegramChanelUrl</small>
                }
            </div>
        </div>
        <div class="col-auto">
            <span class="badge @(Model.IsActive ? "bg-success" : "bg-secondary")">
                @(Model.IsActive ? "Активен" : "Неактивен")
            </span>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-12">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createReportModal">
                <i class="fas fa-plus-circle"></i> Запросить отчет
            </button>
        </div>
    </div>

    <!-- Секция статусов отчетов -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Статусы отчетов</h5>
                </div>
                <div class="card-body">
                    <div id="reportsStatusContainer">
                        <!-- Здесь будут отображаться статусы отчетов -->
                        <p class="text-muted">Загрузка статусов отчетов...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="alert alert-info py-2 mb-0 flex-grow-1 me-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-link me-2"></i>
                            Использовано ссылок: <strong>@currentLinksCount из @maxLinks</strong>
                        </span>
                        <span class="badge bg-@(linksLeft > 5 ? "success" : linksLeft > 0 ? "warning" : "danger")">
                            @if (linksLeft > 0)
                            {
                                <text>Осталось: @linksLeft</text>
                            }
                            else
                            {
                                <text>Лимит исчерпан</text>
                            }
                        </span>
                    </div>
                </div>
                
                @if (currentLinksCount < maxLinks)
                {
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLinkModal">
                        <i class="fas fa-plus me-2"></i>Создать ссылку
                    </button>
                }
                else
                {
                    <button type="button" class="btn btn-secondary" disabled>
                        <i class="fas fa-ban me-2"></i>Лимит достигнут
                    </button>
                }
            </div>
            
            @if (linksLeft <= 5 && linksLeft > 0)
            {
                <div class="mt-2">
                    <small class="text-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Осталось мало ссылок. Рассмотрите возможность удаления неиспользуемых ссылок.
                    </small>
                </div>
            }
        </div>
    </div>
    

    <div class="row">
        <div class="col-12">
            <div class="card" >
                <div class="card-header">
                    <h5 class="card-title mb-0">Трекинговые ссылки</h5>
                </div>
                <div class="card-body">
                    @if (Model.TrackingLinks.Any())
                    {
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>Название</th>
                                <th>Сгенерированная ссылка</th>
                                <th>Клики</th>
                                <th>Создана</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                            </thead>
                            <tbody id="trackingLinksTable">
                            @foreach (var link in Model.TrackingLinks.OrderByDescending(l => l.CreatedAt))
                            {
                            <tr id="link-@link.Id">
                                <td>@link.Name</td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" value="@link.GeneratedUrl" readonly>
                                        <button class="btn btn-outline-secondary copy-btn" type="button" data-url="@link.GeneratedUrl">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary">@link.ClickCount</span>
                                </td>
                                <td>@link.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>
                                                <span class="badge @(link.IsActive ? "bg-success" : "bg-secondary")">
                                                    @(link.IsActive ? "Активна" : "Неактивна")
                                                </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger delete-link-btn" data-link-id="@link.Id" title="Удалить ссылку">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                    }
                    else
                    {
                    <div class="text-center py-4" id="noLinksMessage">
                        <i class="fas fa-link fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Нет созданных трекинговых ссылок</p>
                        <p class="text-muted small">Нажмите "Создать ссылку" чтобы добавить первую</p>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Секция статистики -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Статистика проекта
                    </h5>
                    <div class="d-flex gap-2">
                        <select id="periodSelect" class="form-select form-select-sm" style="width: auto;">
                            <option value="7">Последние 7 дней</option>
                            <option value="30" selected>Последние 30 дней</option>
                            <option value="90">Последние 90 дней</option>
                            <option value="custom">Произвольный период</option>
                        </select>
                        <div id="customPeriod" class="d-none d-flex gap-2">
                            <input type="date" id="startDate" class="form-control form-control-sm" style="width: auto;">
                            <span class="align-self-center">-</span>
                            <input type="date" id="endDate" class="form-control form-control-sm" style="width: auto;">
                            <button id="applyCustomPeriod" class="btn btn-sm btn-primary">Применить</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Карточки с основной статистикой -->
                    <div class="row mb-4" id="statsCards">
                        <div class="col-md-3 col-6">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 class="card-title" id="totalClicks">0</h4>
                                    <p class="card-text">Всего кликов</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 class="card-title" id="totalSubscriptions">0</h4>
                                    <p class="card-text">Подписок</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 class="card-title" id="conversionRate">0%</h4>
                                    <p class="card-text">Конверсия</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 class="card-title" id="uniqueUsers">0</h4>
                                    <p class="card-text">Уникальных пользователей</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Графики -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Клики и подписки по дням</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="dailyChart" height="100"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Источники трафика</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="sourcesChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Устройства и браузеры</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="devicesChart"></canvas>
                                </div>
                            </div>
                        </div>


                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">География пользователей</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="locationsChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Эффективность кампаний</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="campaignsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ТАБЛИЦЫ UTM СТАТИСТИКИ -->
                    <div class="row mt-4">
                        <!-- UTM Sources Table -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-tags me-2"></i>Контент
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover" id="sourcesTable">
                                            <thead>
                                            <tr>
                                                <th>Контент</th>
                                                <th>Клики</th>
                                                <th>Подписки</th>
                                                <th>Конверсия</th>
                                            </tr>
                                            </thead>
                                            <tbody id="sourcesTableBody">
                                            <!-- Данные будут загружаться через JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- UTM Content Table -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-file-alt me-2"></i>Источники
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover" id="contentTable">
                                            <thead>
                                            <tr>
                                                <th>Источники</th>
                                                <th>Клики</th>
                                                <th>Подписки</th>
                                                <th>Конверсия</th>
                                            </tr>
                                            </thead>
                                            <tbody id="contentTableBody">
                                            
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- UTM Campaigns Table -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-bullhorn me-2"></i>Кампании
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover" id="campaignsTable">
                                            <thead>
                                            <tr>
                                                <th>Кампания</th>
                                                <th>Клики</th>
                                                <th>Подписки</th>
                                                <th>Конверсия</th>
                                            </tr>
                                            </thead>
                                            <tbody id="campaignsTableBody">
                                            
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Индикатор загрузки -->
    <div class="row mb-4 d-none" id="loadingStats">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2 mb-0">Загрузка статистики...</p>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Модальное окно создания отчета -->
    <div class="modal fade" id="createReportModal" tabindex="-1" aria-labelledby="createReportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createReportModalLabel">Запрос отчета</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createReportForm">
                    <div class="modal-body">
                        <input type="hidden" name="ProjectId" value="@Model.Id" />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="StartDate" class="form-label">Дата начала *</label>
                                    <input type="date" class="form-control" id="StartDate" name="StartDate" required>
                                    <div class="form-text">Начальная дата периода отчета</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="EndDate" class="form-label">Дата окончания *</label>
                                    <input type="date" class="form-control" id="EndDate" name="EndDate" required>
                                    <div class="form-text">Конечная дата периода отчета</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="Email" class="form-label">Email для отправки отчета *</label>
                            <input type="email" class="form-control" id="Email" name="Email" required
                                   placeholder="example@email.com">
                            <div class="form-text">На этот email будет отправлен готовый отчет</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Формат отчета *</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Format" id="formatPdf" value="Pdf" checked>
                                    <label class="form-check-label" for="formatPdf">
                                        PDF
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Format" id="formatExcel" value="Excel">
                                    <label class="form-check-label" for="formatExcel">
                                        Excel
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-info-circle"></i> После отправки запроса вы сможете отслеживать статус подготовки отчета на этой странице.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary" id="submitReportBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Отправить запрос
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно успешного создания -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success" id="successModalLabel">
                        <i class="fas fa-check-circle"></i> Запрос отправлен
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Ваш запрос на формирование отчета успешно отправлен!</p>
                    <p>Отчет будет отправлен на указанный email после подготовки.</p>
                    <div class="alert alert-info">
                        <strong>Вы можете отслеживать статус готовности отчета</strong> в разделе "Статусы отчетов" на этой странице.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Понятно</button>
                </div>
            </div>
        </div>
    
    
    <div class="modal fade" id="createLinkModal" tabindex="-1" aria-labelledby="createLinkModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createLinkModalLabel">Создать новую трекинговую ссылку</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createLinkForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Название ссылки *</label>
                                    <input type="text" class="form-control" id="name" name="name" required maxlength="100">
                                    <div class="form-text">Максимум 100 символов</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="utmSource" class="form-label">UTM Source</label>
                                    <input type="text" class="form-control" id="utmSource" name="utmSource" value="telegram">
                                    <div class="form-text">Источник трафика (по умолчанию: telegram)</div>
                                </div>
                                <div class="mb-3">
                                    <label for="utmCampaign" class="form-label">UTM Campaign</label>
                                    <input type="text" class="form-control" id="utmCampaign" name="utmCampaign">
                                    <div class="form-text">Название кампании</div>
                                </div>
                                <div class="mb-3">
                                    <label for="utmContent" class="form-label">UTM Content</label>
                                    <input type="text" class="form-control" id="utmContent" name="utmContent">
                                    <div class="form-text">Различитель контента</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="submitCreateLink">
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        Создать ссылку
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<div class="modal fade" id="deleteLinkConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteLinkMessage">Вы точно хотите удалить эту ссылку?</p>
                <div class="alert alert-warning mt-2">
                    <small><i class="fas fa-exclamation-triangle me-1"></i>Статистика кликов будет безвозвратно потеряна</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteLinkBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script>

        //секция отчетов //
        //секция отчетов//
        // Обработка отправки формы
        document.getElementById('createReportForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitReportBtn');
            const spinner = submitBtn.querySelector('.spinner-border');

            // Показываем спиннер
            spinner.classList.remove('d-none');
            submitBtn.disabled = true;

            try {
                const formData = new FormData(this);

                // Валидация данных
                const projectId = formData.get('ProjectId');
                const startDateStr = formData.get('StartDate');
                const endDateStr = formData.get('EndDate');
                const email = formData.get('Email');
                const format = formData.get('Format');

                if (!projectId || !startDateStr || !endDateStr || !email || !format) {
                    alert('Пожалуйста, заполните все поля');
                    return;
                }

                // Преобразуем даты
                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);

                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    alert('Неверный формат даты');
                    return;
                }

                const data = {
                    ProjectId: projectId,
                    StartDate: startDate.toISOString(),
                    EndDate: endDate.toISOString(),
                    Email: email,
                    Format: format
                };

                console.log('📤 Sending data:', JSON.stringify(data, null, 2));

                const response = await fetch('/Reports/SendReportRequest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                console.log('📥 Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Success:', result);

                    // Закрываем модальное окно формы и удаляем backdrop
                    const createReportModal = bootstrap.Modal.getInstance(document.getElementById('createReportModal'));
                    createReportModal.hide();

                    // Ждем пока закроется первое модальное окно
                    setTimeout(() => {
                        // Показываем модальное окно успеха
                        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        successModal.show();

                        // Очищаем форму
                        this.reset();

                        // Обновляем статусы отчетов
                        loadReportsStatus();
                    }, 300);

                } else {
                    const error = await response.json();
                    console.error('❌ Error response:', error);
                    alert('Ошибка: ' + (error.message || 'Не удалось отправить запрос'));
                }
            } catch (error) {
                console.error('❌ Network error:', error);
                alert('Произошла ошибка при отправке запроса');
            } finally {
                // Скрываем спиннер
                spinner.classList.add('d-none');
                submitBtn.disabled = false;
            }
});

        // Обработчик закрытия модального окна успеха
        document.getElementById('successModal').addEventListener('hidden.bs.modal', function () {
            // Удаляем backdrop если он остался
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.remove();
            });

            // Восстанавливаем скролл
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
        });

        // Загрузка статусов отчетов
        async function loadReportsStatus() {
            try {
                const response = await fetch('/Reports/GetProjectReportsStatuses?projectId=@Model.Id');
                if (response.ok) {
                    const reports = await response.json();
                    displayReportsStatus(reports);
                }
            } catch (error) {
                console.error('Error loading reports status:', error);
            }
}

        // Отображение статусов отчетов
        function displayReportsStatus(reports) {
            const container = document.getElementById('reportsStatusContainer');

            if (!reports || reports.length === 0) {
                container.innerHTML = '<p class="text-muted">Отчеты не найдены</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped">';
            html += '<thead><tr><th>Дата запроса</th><th>Формат</th><th>Статус</th><th>Email</th></tr></thead><tbody>';

            reports.forEach(report => {
                const statusClass = getStatusClass(report.status);
                const formatBadge = report.format === 'pdf' ? 'bg-danger' : 'bg-success';

                html += `
            <tr>
                <td>${new Date(report.createdAt).toLocaleDateString()}</td>
                <td><span class="badge ${formatBadge}">${report.format.toUpperCase()}</span></td>
                <td><span class="badge ${statusClass}">${report.status}</span></td>
                <td>${report.email || '-'}</td>
            </tr>
        `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function getStatusClass(status) {
            switch (status.toLowerCase()) {
                case 'completed': return 'bg-success';
                case 'processing': return 'bg-warning';
                case 'error': return 'bg-danger';
                default: return 'bg-secondary';
            }
}

        // Валидация дат
        document.getElementById('EndDate').addEventListener('change', function() {
            const startDate = new Date(document.getElementById('StartDate').value);
            const endDate = new Date(this.value);

            if (startDate && endDate && startDate > endDate) {
                alert('Дата начала не может быть позже даты окончания');
                this.value = '';
            }
});

        // Загружаем статусы при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadReportsStatus();

            // Устанавливаем минимальную дату - сегодня
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('StartDate').max = today;
            document.getElementById('EndDate').max = today;
        });
        //секция отчетов //
        
        let charts = {};
        const projectId = '@Model.Id';

        $(document).ready(function() {
            loadStatistics(30);
            
            $('#periodSelect').change(function() {
                const value = $(this).val();
                if (value === 'custom') {
                    $('#customPeriod').removeClass('d-none');
                } else {
                    $('#customPeriod').addClass('d-none');
                    if (value !== 'custom') {
                        loadStatistics(parseInt(value));
                    }
                }
            });
                
            $('#applyCustomPeriod').click(function() {
                const startDate = $('#startDate').val();
                const endDate = $('#endDate').val();
                if (!startDate || !endDate) {
                    alert('Пожалуйста, выберите обе даты');
                    return;
                }
                loadCustomPeriod(startDate, endDate);
            });
            
            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date();
            monthAgo.setDate(monthAgo.getDate() - 30);
            $('#startDate').val(monthAgo.toISOString().split('T')[0]);
            $('#endDate').val(today);
        });

        function loadStatistics(days) {
            showLoading();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);
            const endDate = new Date();
            loadStatisticsByDates(startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0]);
        }

        function loadCustomPeriod(startDate, endDate) {
            showLoading();
            loadStatisticsByDates(startDate, endDate);
        }

        function loadStatisticsByDates(startDate, endDate) {
            // Очищаем предыдущие графики
            destroyAllCharts();

            fetch(`/api/projects/${projectId}/stats?startDate=${startDate}&endDate=${endDate}`)
                .then(response => {
                    if (!response.ok) throw new Error('Ошибка загрузки статистики');
                    return response.json();
                })
                .then(data => {
                    updateStatsCards(data);
                    updateTables(data);
                    createAllCharts(data);
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error:', error);
                    hideLoading();
                    alert('Ошибка при загрузке статистики: ' + error.message);
                });
        }

        function destroyAllCharts() {
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
        }

        function createAllCharts(data) {
            // График по дням
            if (data.dailyStats && data.dailyStats.length > 0) {
                createDailyChart(data.dailyStats);
            }

            // UTM графики
            if (data.sourceStats && data.sourceStats.length > 0) {
                createSourcesChart(data.sourceStats);
            }

            if (data.contentStats && data.contentStats.length > 0) {
                createContentChart(data.contentStats);
            }

            if (data.campaignStats && data.campaignStats.length > 0) {
                createCampaignsChart(data.campaignStats);
            }

            if (data.locationStats && data.locationStats.length > 0) {
                createLocationsChart(data.locationStats);
            }

            if (data.deviceStats && data.deviceStats.length > 0) {
                createDevicesChart(data.deviceStats);
            }
}

        function createDailyChart(dailyData) {
            const ctx = document.getElementById('dailyChart');
            if (!ctx) return;

            // Увеличиваем высоту canvas
            const container = ctx.closest('.card-body');
            if (container) {
                ctx.style.height = '400px'; // Увеличиваем высоту
                ctx.height = 400;
            }

            charts.dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.map(d => new Date(d.date).toLocaleDateString('ru-RU')),
                    datasets: [
                        {
                            label: 'Клики',
                            data: dailyData.map(d => d.clicks || 0),
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 3, // Толще линия
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Подписки',
                            data: dailyData.map(d => d.subscriptions || 0),
                            borderColor: '#4BC0C0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 3, // Толще линия
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Важно! Отключаем сохранение пропорций
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                },
                                maxRotation: 45
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function createSourcesChart(sourcesData) {
            const ctx = document.getElementById('sourcesChart');
            if (!ctx) return;

            charts.sourcesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sourcesData.map(s => s.source === 'unknown' ? 'Не указан' : s.source),
                    datasets: [{
                        data: sourcesData.map(s => s.clicks || 0),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function createContentChart(contentData) {
            const ctx = document.getElementById('contentChart');
            if (!ctx) return;

            charts.contentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: contentData.map(c => c.content === 'unknown' ? 'Не указан' : c.content),
                    datasets: [{
                        data: contentData.map(c => c.clicks || 0),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function createCampaignsChart(campaignsData) {
            const ctx = document.getElementById('campaignsChart');
            if (!ctx) return;

            const topCampaigns = campaignsData.slice(0, 8);

            charts.campaignsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topCampaigns.map(c => c.campaign === 'unknown' ? 'Не указана' : c.campaign),
                    datasets: [
                        {
                            label: 'Клики',
                            data: topCampaigns.map(c => c.clicks || 0),
                            backgroundColor: 'rgba(54, 162, 235, 0.7)'
                        },
                        {
                            label: 'Подписки',
                            data: topCampaigns.map(c => c.subscriptions || 0),
                            backgroundColor: 'rgba(75, 192, 192, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true },
                        x: { ticks: { maxRotation: 45 } }
                    }
                }
            });
        }

        function createLocationsChart(locationsData) {
            const ctx = document.getElementById('locationsChart');
            if (!ctx) return;

            const topLocations = locationsData.slice(0, 8);

            charts.locationsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topLocations.map(l => {
                        if (l.city && l.country) return `${l.country} - ${l.city}`;
                        if (l.country) return l.country;
                        return 'Не указано';
                    }),
                    datasets: [
                        {
                            label: 'Клики',
                            data: topLocations.map(l => l.clicks || 0),
                            backgroundColor: 'rgba(255, 99, 132, 0.7)'
                        },
                        {
                            label: 'Подписки',
                            data: topLocations.map(l => l.subscriptions || 0),
                            backgroundColor: 'rgba(75, 192, 192, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true },
                        x: { ticks: { maxRotation: 45 } }
                    }
                }
            });
        }
        
        function createDevicesChart(devicesData) {
            const ctx = document.getElementById('devicesChart');
            if (!ctx) return;

            const topDevices = devicesData.slice(0, 6);

            charts.devicesChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: topDevices.map(d => {
                        const device = d.deviceType || 'Неизвестно';
                        const browser = d.browser || 'Неизвестно';
                        return `${device} - ${browser}`;
                    }),
                    datasets: [{
                        data: topDevices.map(d => d.clicks || 0),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateStatsCards(data) {
            $('#totalClicks').text(data.totalClicks?.toLocaleString() || '0');
            $('#totalSubscriptions').text(data.totalSubscriptions?.toLocaleString() || '0');
            $('#conversionRate').text((data.conversionRate || 0) + '%');
            $('#uniqueUsers').text(data.uniqueUsers?.toLocaleString() || '0');
        }

        function updateTables(data) {
            updateSourcesTable(data.sourceStats || []);
            updateContentTable(data.contentStats || []);
            updateCampaignsTable(data.campaignStats || []);
        }

        function updateSourcesTable(sourcesData) {
            const tbody = document.getElementById('sourcesTableBody');
            if (!tbody) return;

            let html = '';
            if (!sourcesData || sourcesData.length === 0) {
                html = '<tr><td colspan="4" class="text-center text-muted">Нет данных</td></tr>';
            } else {
                sourcesData.forEach(source => {
                    html += `
                <tr>
                    <td>${source.source === 'unknown' ? '<span class="text-muted">Не указан</span>' : source.source}</td>
                    <td>${source.clicks?.toLocaleString() || '0'}</td>
                    <td>${source.subscriptions?.toLocaleString() || '0'}</td>
                    <td><span class="badge bg-${getConversionRateColor(source.conversionRate || 0)}">${source.conversionRate || 0}%</span></td>
                </tr>
            `;
                });
            }
            tbody.innerHTML = html;
        }

        function updateContentTable(contentData) {
            const tbody = document.getElementById('contentTableBody');
            if (!tbody) return;

            let html = '';
            if (!contentData || contentData.length === 0) {
                html = '<tr><td colspan="4" class="text-center text-muted">Нет данных</td></tr>';
            } else {
                contentData.forEach(content => {
                    html += `
                <tr>
                    <td>${content.content === 'unknown' ? '<span class="text-muted">Не указан</span>' : content.content}</td>
                    <td>${content.clicks?.toLocaleString() || '0'}</td>
                    <td>${content.subscriptions?.toLocaleString() || '0'}</td>
                    <td><span class="badge bg-${getConversionRateColor(content.conversionRate || 0)}">${content.conversionRate || 0}%</span></td>
                </tr>
            `;
                });
            }
            tbody.innerHTML = html;
        }

        function updateCampaignsTable(campaignsData) {
            const tbody = document.getElementById('campaignsTableBody');
            if (!tbody) return;

            let html = '';
            if (!campaignsData || campaignsData.length === 0) {
                html = '<tr><td colspan="4" class="text-center text-muted">Нет данных</td></tr>';
            } else {
                campaignsData.forEach(campaign => {
                    html += `
                <tr>
                    <td>${campaign.campaign === 'unknown' ? '<span class="text-muted">Не указана</span>' : campaign.campaign}</td>
                    <td>${campaign.clicks?.toLocaleString() || '0'}</td>
                    <td>${campaign.subscriptions?.toLocaleString() || '0'}</td>
                    <td><span class="badge bg-${getConversionRateColor(campaign.conversionRate || 0)}">${campaign.conversionRate || 0}%</span></td>
                </tr>
            `;
                });
            }
            tbody.innerHTML = html;
        }

        function getConversionRateColor(rate) {
            if (rate >= 10) return 'success';
            if (rate >= 5) return 'warning';
            return 'danger';
        }

        function showLoading() {
            $('#statsCards').css('opacity', '0.5');
        }

        function hideLoading() {
            $('#statsCards').css('opacity', '1');
        }
        
        const MAX_LINKS = @maxLinks;
        let currentLinksCount = @currentLinksCount;

        function updateLinksCounter(newCount) {
            currentLinksCount = newCount;
            const linksLeft = MAX_LINKS - currentLinksCount;
            
            $('.alert-info strong').text(`${currentLinksCount} из ${MAX_LINKS}`);
            $('.alert-info .badge').text(linksLeft > 0 ? `Осталось: ${linksLeft}` : 'Лимит исчерпан');
            $('.alert-info .badge').removeClass('bg-success bg-warning bg-danger')
                .addClass(linksLeft > 5 ? 'bg-success' : linksLeft > 0 ? 'bg-warning' : 'bg-danger');
            
            if (currentLinksCount >= MAX_LINKS) {
                $('.btn-primary[data-bs-target="#createLinkModal"]')
                    .replaceWith('<button type="button" class="btn btn-secondary" disabled><i class="fas fa-ban me-2"></i>Лимит достигнут</button>');
            }
        }
        
        $('#submitCreateLink').on('click', function() {
            console.log('Кнопка нажата');

            const btn = $(this);
            const spinner = btn.find('.spinner-border');
            const modal = $('#createLinkModal');

            
            const name = $('#name').val().trim();
        
            
            if (!name) {
                showAlert('Введите название ссылки', 'danger');
                $('#name').focus();
                return;
            }

            spinner.removeClass('d-none');
            btn.prop('disabled', true);

            const formData = {
                projectId: '@Model.Id',
                name: name,
                utmSource: $('#utmSource').val() || 'telegram',
                utmCampaign: $('#utmCampaign').val() || '',
                utmContent: $('#utmContent').val() || ''
            };

            $.ajax({
                url: '@Url.Action("CreateProjectTrackingLink", "Project")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    console.log('Ответ сервера:', response);

                    if (response.success) {
                        addLinkToTable(response.link);
                        updateLinksCounter(response.currentCount);

                        // Закрываем модальное окно
                        const bootstrapModal = bootstrap.Modal.getInstance(modal[0]);
                        bootstrapModal.hide();

                        // Очищаем backdrop
                        $('body').removeClass('modal-open');
                        $('.modal-backdrop').remove();

                        // Очищаем форму
                        $('#createLinkForm')[0].reset();
                        $('#utmSource').val('telegram');

                        showAlert('Ссылка успешно создана!', 'success');
                    } else {
                        showAlert('Ошибка: ' + response.error, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка AJAX:', status, error);
                    showAlert('Ошибка при создании ссылки: ' + error, 'danger');
                },
                complete: function() {
                    // Всегда разблокируем кнопку
                    spinner.addClass('d-none');
                    btn.prop('disabled', false);
                }
            });
        });
        
      
        $('#createLinkForm').on('keypress', function(e) {
            if (e.which === 13) { // Enter key
                e.preventDefault();
                $('#submitCreateLink').click();
            }
        });
        
     
        $('#createLinkModal').on('show.bs.modal', function () {
            $('#createLinkForm')[0].reset();
            $('#utmSource').val('telegram');
        });


        let linkToDelete = null;
        let linkToDeleteRow = null;

        $(document).on('click', '.delete-link-btn', function() {
            const linkId = $(this).data('link-id');
            const linkName = $(this).closest('tr').find('td:first').text();
            linkToDelete = linkId;
            linkToDeleteRow = $('#link-' + linkId);

            $('#deleteLinkMessage').html(`Вы точно хотите удалить ссылку "<strong>${linkName}</strong>"?`);

            const deleteModal = new bootstrap.Modal(document.getElementById('deleteLinkConfirmModal'));
            deleteModal.show();
        });

        $('#confirmDeleteLinkBtn').on('click', function() {
            if (!linkToDelete) return;

            const btn = $(this);
            const originalText = btn.html();

            btn.prop('disabled', true);
            btn.html('<span class="spinner-border spinner-border-sm" role="status"></span> Удаление...');

            $.ajax({
                url: '@Url.Action("DeleteTrackingLink", "Project")',
                type: 'POST',
                data: { linkId: linkToDelete },
                success: function(response) {
                    if (response.success) {
                        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteLinkConfirmModal'));
                        deleteModal.hide();

                        linkToDeleteRow.fadeOut(300, function() {
                            $(this).remove();
                            updateLinksCounter(response.currentCount);

                            if ($('#trackingLinksTable tr').length === 0) {
                                $('#noLinksMessage').removeClass('d-none');
                            }
                        });

                        showAlert('Ссылка успешно удалена', 'success');
                    } else {
                        showAlert('Ошибка: ' + response.error, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('Ошибка при удалении ссылки: ' + error, 'danger');
                },
                complete: function() {
                    linkToDelete = null;
                    linkToDeleteRow = null;

                    
                    btn.prop('disabled', false);
                    btn.html(originalText);
                }
            });
        });

        $('#deleteLinkConfirmModal').on('hidden.bs.modal', function() {
            linkToDelete = null;
            linkToDeleteRow = null;
            $('#confirmDeleteLinkBtn').prop('disabled', false).html('Удалить');
        });
      
        $(document).on('click', '.copy-btn', function() {
            const url = $(this).data('url');
            const btn = $(this);
            const originalHtml = btn.html();
            
            navigator.clipboard.writeText(url).then(function() {
                btn.html('<i class="fas fa-check"></i>');
                setTimeout(() => btn.html(originalHtml), 2000);
            }).catch(function() {
                // Fallback для старых браузеров
                const tempInput = $('<input>');
                $('body').append(tempInput);
                tempInput.val(url).select();
                document.execCommand('copy');
                tempInput.remove();
                
                btn.html('<i class="fas fa-check"></i>');
                setTimeout(() => btn.html(originalHtml), 2000);
            });
        });
        
       
        function addLinkToTable(link) {
            const formattedDate = new Date(link.createdAt).toLocaleString('ru-RU');
            
            const newRow = `
                <tr id="link-${link.id}">
                    <td>${link.name}</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" value="${link.generatedUrl}" readonly>
                            <button class="btn btn-outline-secondary copy-btn" type="button" data-url="${link.generatedUrl}">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </td>
                    <td><span class="badge bg-primary">${link.clickCount}</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <span class="badge bg-success">Активна</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger delete-link-btn" data-link-id="${link.id}" title="Удалить ссылку">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            $('#noLinksMessage').addClass('d-none');
            $('#trackingLinksTable').prepend(newRow);
        }

        function addLinkToTable(link) {
            const formattedDate = new Date(link.createdAt).toLocaleString('ru-RU');

            // Формируем текст для tooltip с UTM параметрами
            const utmTooltip = `
        UTM параметры:
        ▸ Source: ${link.utmSource || 'не указан'}
        ▸ Campaign: ${link.utmCampaign || 'не указана'}
        ▸ Content: ${link.utmContent || 'не указан'}
    `.trim();

            const newRow = `
        <tr id="link-${link.id}">
            <td>
                <span class="link-name" 
                      data-bs-toggle="tooltip" 
                      data-bs-title="${utmTooltip}"
                      data-bs-html="true">
                    ${link.name}
                </span>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" value="${link.generatedUrl}" readonly>
                    <button class="btn btn-outline-secondary copy-btn" type="button" data-url="${link.generatedUrl}">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </td>
            <td><span class="badge bg-primary">${link.clickCount}</span></td>
            <td>${formattedDate}</td>
            <td>
                <span class="badge bg-success">Активна</span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-danger delete-link-btn" data-link-id="${link.id}" title="Удалить ссылку">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;

            $('#noLinksMessage').addClass('d-none');
            $('#trackingLinksTable').prepend(newRow);

            // Инициализируем tooltip для новой строки
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        function showAlert(message, type) {
            
            $('.alert-dismissible').alert('close');
            
            const alert = $(`
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('.container-fluid').prepend(alert);
            
            setTimeout(() => {
                alert.alert('close');
            }, 5000);
        }


        $(document).ready(function() {
            console.log('Скрипт загружен и готов');
            console.log('MAX_LINKS:', MAX_LINKS);
            console.log('currentLinksCount:', currentLinksCount);
        });
    
    </script>
    
}