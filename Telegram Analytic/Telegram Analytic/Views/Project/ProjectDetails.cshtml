@model Project
@{
    ViewData["Title"] = Model.Name;
    var maxLinks = ViewBag.MaxLinksPerProject as int? ?? 20;
    var currentLinksCount = ViewBag.CurrentLinksCount as int? ?? 0;
    var linksLeft = maxLinks - currentLinksCount;
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>@Model.Name</h1>
            <div class="text-muted">
                <small>Создан: @Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                @if (Model.UpdatedAt.HasValue)
                {
                    <small> | Обновлен: @Model.UpdatedAt.Value.ToString("dd.MM.yyyy HH:mm")</small>
                }
                @if (!string.IsNullOrEmpty(Model.TelegramChatId))
                {
                    <small> | Telegram ID: @Model.TelegramChatId</small>
                }
            </div>
        </div>
        <div class="col-auto">
            <span class="badge @(Model.IsActive ? "bg-success" : "bg-secondary")">
                @(Model.IsActive ? "Активен" : "Неактивен")
            </span>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="alert alert-info py-2 mb-0 flex-grow-1 me-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-link me-2"></i>
                            Использовано ссылок: <strong>@currentLinksCount из @maxLinks</strong>
                        </span>
                        <span class="badge bg-@(linksLeft > 5 ? "success" : linksLeft > 0 ? "warning" : "danger")">
                            @if (linksLeft > 0)
                            {
                                <text>Осталось: @linksLeft</text>
                            }
                            else
                            {
                                <text>Лимит исчерпан</text>
                            }
                        </span>
                    </div>
                </div>
                
                @if (currentLinksCount < maxLinks)
                {
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLinkModal">
                        <i class="fas fa-plus me-2"></i>Создать ссылку
                    </button>
                }
                else
                {
                    <button type="button" class="btn btn-secondary" disabled>
                        <i class="fas fa-ban me-2"></i>Лимит достигнут
                    </button>
                }
            </div>
            
            @if (linksLeft <= 5 && linksLeft > 0)
            {
                <div class="mt-2">
                    <small class="text-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Осталось мало ссылок. Рассмотрите возможность удаления неиспользуемых ссылок.
                    </small>
                </div>
            }
        </div>
    </div>

    <div class="modal fade" id="createLinkModal" tabindex="-1" aria-labelledby="createLinkModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createLinkModalLabel">Создать новую трекинговую ссылку</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createLinkForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Название ссылки *</label>
                                    <input type="text" class="form-control" id="name" name="name" required maxlength="100">
                                    <div class="form-text">Максимум 100 символов</div>
                                </div>
                                <div class="mb-3">
                                    <label for="baseUrl" class="form-label">Целевой URL *</label>
                                    <input type="url" class="form-control" id="baseUrl" name="baseUrl" required>
                                    <div class="form-text">Например: https://example.com</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="utmSource" class="form-label">UTM Source</label>
                                    <input type="text" class="form-control" id="utmSource" name="utmSource" value="telegram">
                                    <div class="form-text">Источник трафика (по умолчанию: telegram)</div>
                                </div>
                                <div class="mb-3">
                                    <label for="utmCampaign" class="form-label">UTM Campaign</label>
                                    <input type="text" class="form-control" id="utmCampaign" name="utmCampaign">
                                    <div class="form-text">Название кампании</div>
                                </div>
                                <div class="mb-3">
                                    <label for="utmContent" class="form-label">UTM Content</label>
                                    <input type="text" class="form-control" id="utmContent" name="utmContent">
                                    <div class="form-text">Различитель контента</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="submitCreateLink">
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        Создать ссылку
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Список трекинговых ссылок -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Трекинговые ссылки</h5>
                </div>
                <div class="card-body">
                    @if (Model.TrackingLinks.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Сгенерированная ссылка</th>
                                        <th>Клики</th>
                                        <th>Создана</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="trackingLinksTable">
                                    @foreach (var link in Model.TrackingLinks.OrderByDescending(l => l.CreatedAt))
                                    {
                                        <tr id="link-@link.Id">
                                            <td>@link.Name</td>
                                            <td>
                                                <div class="input-group input-group-sm">
                                                    <input type="text" class="form-control" value="@link.GeneratedUrl" readonly>
                                                    <button class="btn btn-outline-secondary copy-btn" type="button" data-url="@link.GeneratedUrl">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">@link.ClickCount</span>
                                            </td>
                                            <td>@link.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                                            <td>
                                                <span class="badge @(link.IsActive ? "bg-success" : "bg-secondary")">
                                                    @(link.IsActive ? "Активна" : "Неактивна")
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-danger delete-link-btn" data-link-id="@link.Id" title="Удалить ссылку">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4" id="noLinksMessage">
                            <i class="fas fa-link fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Нет созданных трекинговых ссылок</p>
                            <p class="text-muted small">Нажмите "Создать ссылку" чтобы добавить первую</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const MAX_LINKS = @maxLinks;
        let currentLinksCount = @currentLinksCount;

        function updateLinksCounter(newCount) {
            currentLinksCount = newCount;
            const linksLeft = MAX_LINKS - currentLinksCount;
            
            $('.alert-info strong').text(`${currentLinksCount} из ${MAX_LINKS}`);
            $('.alert-info .badge').text(linksLeft > 0 ? `Осталось: ${linksLeft}` : 'Лимит исчерпан');
            $('.alert-info .badge').removeClass('bg-success bg-warning bg-danger')
                .addClass(linksLeft > 5 ? 'bg-success' : linksLeft > 0 ? 'bg-warning' : 'bg-danger');
            
            if (currentLinksCount >= MAX_LINKS) {
                $('.btn-primary[data-bs-target="#createLinkModal"]')
                    .replaceWith('<button type="button" class="btn btn-secondary" disabled><i class="fas fa-ban me-2"></i>Лимит достигнут</button>');
            }
        }

        $('#submitCreateLink').on('click', function() {
            console.log('Кнопка нажата'); 
            
            const btn = $(this);
            const spinner = btn.find('.spinner-border');
            
            const name = $('#name').val().trim();
            const baseUrl = $('#baseUrl').val().trim();
            
            if (!name) {
                showAlert('Введите название ссылки', 'danger');
                $('#name').focus();
                return;
            }
            
            if (!baseUrl) {
                showAlert('Введите целевой URL', 'danger');
                $('#baseUrl').focus();
                return;
            }
            
            if (!baseUrl.startsWith('http://') && !baseUrl.startsWith('https://')) {
                showAlert('URL должен начинаться с http:// или https://', 'danger');
                $('#baseUrl').focus();
                return;
            }
            
            console.log('Данные для отправки:', {
                projectId: '@Model.Id',
                name: name,
                baseUrl: baseUrl,
                utmSource: $('#utmSource').val(),
                utmCampaign: $('#utmCampaign').val(),
                utmContent: $('#utmContent').val()
            });
            
            spinner.removeClass('d-none');
            btn.prop('disabled', true);
            
            const formData = {
                projectId: '@Model.Id',
                name: name,
                baseUrl: baseUrl,
                utmSource: $('#utmSource').val() || 'telegram',
                utmCampaign: $('#utmCampaign').val() || '',
                utmContent: $('#utmContent').val() || ''
            };
            
            $.ajax({
                url: '@Url.Action("CreateProjectTrackingLink", "Project")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    console.log('Ответ сервера:', response);
                    
                    if (response.success) {
                       
                        addLinkToTable(response.link);
                        
                        updateLinksCounter(response.currentCount);
                        $('#createLinkModal').modal('hide');
                        $('#createLinkForm')[0].reset();
                        $('#utmSource').val('telegram');
                        showAlert('Ссылка успешно создана!', 'success');
                    } else {
                        showAlert('Ошибка: ' + response.error, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка AJAX:', status, error);
                    console.error('Детали ошибки:', xhr.responseText);
                    showAlert('Ошибка при создании ссылки: ' + error, 'danger');
                },
                complete: function() {
                    spinner.addClass('d-none');
                    btn.prop('disabled', false);
                }
            });
        });
        
      
        $('#createLinkForm').on('keypress', function(e) {
            if (e.which === 13) { // Enter key
                e.preventDefault();
                $('#submitCreateLink').click();
            }
        });
        
     
        $('#createLinkModal').on('show.bs.modal', function () {
            $('#createLinkForm')[0].reset();
            $('#utmSource').val('telegram');
        });
        
        
        $(document).on('click', '.delete-link-btn', function() {
            const linkId = $(this).data('link-id');
            const row = $('#link-' + linkId);
            
            if (confirm('Вы уверены, что хотите удалить эту ссылку? Статистика кликов будет потеряна.')) {
                $.ajax({
                    url: '@Url.Action("DeleteTrackingLink", "Project")',
                    type: 'POST',
                    data: { linkId: linkId },
                    success: function(response) {
                        if (response.success) {
                            row.fadeOut(300, function() {
                                $(this).remove();
                                updateLinksCounter(response.currentCount);
                                
                                if ($('#trackingLinksTable tr').length === 0) {
                                    $('#noLinksMessage').removeClass('d-none');
                                }
                            });
                            showAlert('Ссылка удалена', 'success');
                        } else {
                            showAlert('Ошибка: ' + response.error, 'danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        showAlert('Ошибка при удалении ссылки: ' + error, 'danger');
                    }
                });
            }
        });
        
      
        $(document).on('click', '.copy-btn', function() {
            const url = $(this).data('url');
            const btn = $(this);
            const originalHtml = btn.html();
            
            navigator.clipboard.writeText(url).then(function() {
                btn.html('<i class="fas fa-check"></i>');
                setTimeout(() => btn.html(originalHtml), 2000);
            }).catch(function() {
                // Fallback для старых браузеров
                const tempInput = $('<input>');
                $('body').append(tempInput);
                tempInput.val(url).select();
                document.execCommand('copy');
                tempInput.remove();
                
                btn.html('<i class="fas fa-check"></i>');
                setTimeout(() => btn.html(originalHtml), 2000);
            });
        });
        
       
        function addLinkToTable(link) {
            const formattedDate = new Date(link.createdAt).toLocaleString('ru-RU');
            
            const newRow = `
                <tr id="link-${link.id}">
                    <td>${link.name}</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" value="${link.generatedUrl}" readonly>
                            <button class="btn btn-outline-secondary copy-btn" type="button" data-url="${link.generatedUrl}">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </td>
                    <td><span class="badge bg-primary">${link.clickCount}</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <span class="badge bg-success">Активна</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger delete-link-btn" data-link-id="${link.id}" title="Удалить ссылку">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            $('#noLinksMessage').addClass('d-none');
            $('#trackingLinksTable').prepend(newRow);
        }
        
      
        function showAlert(message, type) {
            
            $('.alert-dismissible').alert('close');
            
            const alert = $(`
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('.container-fluid').prepend(alert);
            
            setTimeout(() => {
                alert.alert('close');
            }, 5000);
        }


        $(document).ready(function() {
            console.log('Скрипт загружен и готов');
            console.log('MAX_LINKS:', MAX_LINKS);
            console.log('currentLinksCount:', currentLinksCount);
        });
    </script>
}